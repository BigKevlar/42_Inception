# SELECCIONAMOS IMAGEN A MONTAR SOBRE LA CUAL INSTALAREMOS EL BACKEND MARIADB.
FROM debian:bullseye

# SELECCIONAMOS LOS "ARGUMENTOS DE CONSTRUCCION" QUE SERVIRAN PARA INICIALIZAR LAS VARIABLES DE ENTORNO.
ARG MARIADB_NAME
ARG MARIADB_ROOT_PASS
ARG MARIADB_USER
ARG MARIADB_USER_PASS

ENV MARIADB_NAME=${MARIADB_NAME} \
    MARIADB_ROOT_PASS=$MARIADB_ROOT_PASS \
    MARIADB_USER=${MARIADB_USER} \
    MARIADB_USER_PASS=${MARIADB_USER_PASS}

# UNA VEZ MONTADA LA IMAGEN DE DEBIAN, Y DENTRO DE ELLA, ACTUALIZAMOS E INSTALAMOS MARIADB Y BORRAMOS ARCHIVOS BASURA (SOLO EN CASO DE LOS MAC DEL CAMPUS, PARA QUE VAYA TODO OK XD).
RUN apt-get update && \
    apt-get install mariadb-server -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*s

# COPIAMOS/SUSTITUIMOS EL ARCHIVO DE CONFIGURACION DE MYSQL POR EL NUESTRO PERSONALIZADO.
COPY ./my.cnf /etc/mysql/my.cnf

#   - CREAMOS DIRECTORIO PARA MARIADB.
#   - CAMBIAMOS EL PROPIETARIO PARA QUE MYSQL TENGA PERMISOS EN MARIADB.
RUN mkdir -p /var/run/mysqld/ && \
    chown -R mysql:mysql /var/run/mysqld/

# EXPONEMOS EL PUERTO ESTANDAR DE MARIADB.
EXPOSE 3306

# EJECUCION DE COMANDOS:
#   - INICIAMOS MARIADB
#   - CREAMOS EL FICHERO DE LA BASE DE DATOS SI NO EXISTE.
#   - CREAMOS EL USUARIO Y CONTRASEÑA SI NO EXISTE.
#   - ASIGNAMOS PERMISOS AL USUARIO.
#   - ASIGNAMOS PERMISOS DEL USUARIO SOBRE LA BASE DE DATOS.
#   - CAMBIAMOS LA CONTRASEÑA DE ROOT POR LA QUE TENEMOS EN EN .ENV.
#   - APLICAMOS LOS CAMBIOS EJECUTANDO EL ARCHIVO "MSQL_DB.SQL".
RUN service mariadb start && \
    echo "CREATE DATABASE IF NOT EXISTS ${MARIADB_NAME};" \
    > msql_db.sql && \
    echo "CREATE USER IF NOT EXISTS '${MARIADB_USER}'@'%' IDENTIFIED BY '${MARIADB_PASS}' ;" \
    >> msql_db.sql && \
    echo "GRANT ALL PRIVILEGES ON ${MARIADB_NAME}.* TO '${MARIADB_USER}'@'%' ;" \
    >> msql_db.sql && \
    echo "FLUSH PRIVILEGES;" \
    >> msql_db.sql && \
    echo "ALTER USER 'root'@'localhost' IDENTIFIED BY '${MARIADB_ROOT_PASS}' ;" \
    >> msql_db.sql && mariadb < msql_db.sql

# DEFINIMOS EL COMANDO PARA INICIAR MARIADB.
CMD ["mysqld"]